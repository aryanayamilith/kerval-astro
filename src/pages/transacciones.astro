---
import BaseLayout from "../layouts/BaseLayout.astro";
import { readFileSync } from "fs";
import Papa from "papaparse";

// 游릱 Definimos el tipo de datos esperado
interface Transaccion {
  Sector: string;
  "Tipo de transacci칩n": string;
  Pa칤s?: string;
  "Compa침칤a 1"?: string;
  "Compa침칤a 2"?: string;
  Descripci칩n?: string;
}

// 游릱 Cargar CSV
const csvData = readFileSync("./src/data/transacciones.csv", "utf8");
const { data } = Papa.parse(csvData, { header: true });

// 游릱 Tipado correcto
const transacciones = data as unknown as Transaccion[];

// 游릱 Extraer opciones 칰nicas
const sectores = [...new Set(transacciones.map((t) => t.Sector))].filter(Boolean);
const tipos = [...new Set(transacciones.map((t) => t["Tipo de transacci칩n"]))].filter(Boolean);
---

<BaseLayout
  title="Transacciones Financieras en Espa침a | Kerval Advisory Partners"
  description="Experiencia comprobada en operaciones financieras y estrat칠gicas en Espa침a. Conoce nuestras transacciones de M&A, financiaci칩n e inversi칩n."
>

  <!-- 游릱 Banner -->
  <header style="position: relative; height: 350px; background: url('/images/banner-transacciones.jpg') center/cover no-repeat;">
    <div style="position: absolute; inset: 0; background: rgba(0,32,96,0.65);"></div>
    <div style="position: relative; z-index: 1; height: 100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; text-align:center;">
      <h1 style="font-family:'Calibri', sans-serif; font-size: 3rem; margin:0;">Transacciones</h1>
      <p style="font-family:'Calibri', sans-serif; font-size:1.5rem; margin-top:1rem; max-width:800px;">
        Acompa침amos a empresas en procesos de financiaci칩n, estrategia y crecimiento con resultados comprobados.
      </p>
    </div>
  </header>

  <!-- 游릱 Filtros -->
  <section class="filtros">
    <div class="filtro">
      <label for="sector">Sector</label>
      <select id="sector">
        <option value="Todos">Todos</option>
        {sectores.map((s) => <option value={String(s)}>{s}</option>)}
      </select>
    </div>

    <div class="filtro">
      <label for="tipo">Tipo de Transacci칩n</label>
      <select id="tipo">
        <option value="Todos">Todos</option>
        {tipos.map((t) => <option value={String(t)}>{t}</option>)}
      </select>
    </div>

    <button id="btnAplicar" class="btn-aplicar">Aplicar</button>
  </section>

  <!-- 游릱 Grid -->
  <section id="grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:2rem; padding:0 1rem 2.5rem; max-width:1100px; margin:0 auto;">
    {transacciones.map((t) => (
      <article class="card" data-sector={t.Sector} data-tipo={t["Tipo de transacci칩n"]}>
        <div class="card-header">
          <div class="header-left">
            <h4 class="sector">{t.Sector}</h4>
            <h3 class="tipo">{t["Tipo de transacci칩n"]}</h3>
          </div>

          {t.Pa칤s && (
            (() => {
              const countryCodes = {
                "Espa침a": "es",
                "Per칰": "pe",
                "Estados Unidos": "us",
                "Canad치": "ca",
                "Portugal": "pt",
                "Alemania": "de",
                "Venezuela": "ve",
                "N칤ger": "ne"
              };
              const code = countryCodes[t.Pa칤s as keyof typeof countryCodes] || "default";
              return <img src={`/images/flags/${code}.png`} alt={t.Pa칤s} class="flag" />;
            })()
          )}
        </div>

        <hr class="divider" />

        <div class="card-body">
          {t["Compa침칤a 1"] && (
            (() => {
              const c1 = (t["Compa침칤a 1"] || "").trim().toLowerCase();
              const confidenciales = [
                "confidencial",
                "target confidencial",
                "inversor confidencial",
                "portfolio de farmacias",
                "target",
                "inversor"
              ];
              if (confidenciales.some((p) => c1.includes(p))) {
                return <p class="confidencial">{t["Compa침칤a 1"]}</p>;
              }
              return (
                <img
                  src={`/images/transacciones/${t["Compa침칤a 1"]
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/침/g, "n")
                    .replace(/\s+/g, "_")
                    .replace(/&/g, "y")
                    .replace(/[^a-z0-9_]/g, "")
                  }.svg`}
                  alt={t["Compa침칤a 1"]}
                  loading="lazy"
                  class="logo"
                />
              );
            })()
          )}

          {t.Descripci칩n && <p class="descripcion">{t.Descripci칩n}</p>}

          {t["Compa침칤a 2"] && (
            (() => {
              const c2 = (t["Compa침칤a 2"] || "").trim().toLowerCase();
              const confidenciales = [
                "confidencial",
                "target confidencial",
                "inversor confidencial",
                "portfolio de farmacias",
                "target",
                "inversor"
              ];
              if (confidenciales.some((p) => c2.includes(p))) {
                return <p class="confidencial">{t["Compa침칤a 2"]}</p>;
              }
              return (
                <img
                  src={`/images/transacciones/${t["Compa침칤a 2"]
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/침/g, "n")
                    .replace(/\s+/g, "_")
                    .replace(/&/g, "y")
                    .replace(/[^a-z0-9_]/g, "")
                  }.svg`}
                  alt={t["Compa침칤a 2"]}
                  loading="lazy"
                  class="logo"
                />
              );
            })()
          )}
        </div>
      </article>
    ))}
  </section>

  <!-- 游릱 Script de filtrado -->
  <script>
    const sectorSelect = document.getElementById('sector') as HTMLSelectElement | null;
    const tipoSelect = document.getElementById('tipo') as HTMLSelectElement | null;
    const btnAplicar = document.getElementById('btnAplicar') as HTMLButtonElement | null;
    const cards = document.querySelectorAll('.card') as NodeListOf<HTMLElement>;

    btnAplicar?.addEventListener('click', () => {
      const s = sectorSelect?.value || 'Todos';
      const t = tipoSelect?.value || 'Todos';

      cards.forEach((c) => {
        const matchS = s === 'Todos' || c.dataset.sector === s;
        const matchT = t === 'Todos' || c.dataset.tipo === t;
        c.style.display = matchS && matchT ? 'block' : 'none';
      });
    });
  </script>

  <style>
    /* ===== FILTROS ===== */
    .filtros {
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 2rem 1rem;
      flex-wrap: wrap;
      max-width: 1100px;
      margin: 0 auto;
    }

    .filtro label {
      display: block;
      font-weight: bold;
      color: #002060;
      margin-bottom: 0.5rem;
      font-family: 'Calibri', sans-serif;
    }

    .filtro select {
      padding: 0.55rem 0.7rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 220px;
      font-family: 'Calibri', sans-serif;
      background: #fff;
    }

    .btn-aplicar {
      align-self: flex-end;
      padding: 0.7rem 1.5rem;
      background: #c00000;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      font-family: 'Calibri', sans-serif;
      cursor: pointer;
      width: auto;
    }

    /* 游릴 Mobile */
    @media (max-width: 768px) {
      .filtros {
        justify-content: flex-start !important;
        align-items: flex-start !important;
        text-align: left !important;
        flex-direction: column !important;
        padding: 1.25rem 1rem !important;
      }

      .filtro {
        width: 100%;
        max-width: 460px;
      }

      .btn-aplicar {
        align-self: flex-start !important;
        margin-top: 0.5rem;
        width: fit-content !important;
        max-width: none !important;
      }
    }

    /* ===== CARDS ===== */
    .card {
      background: #f2f2f2;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      font-family: 'Calibri', sans-serif;
      color: #002060;
      transition: transform 0.2s ease;
    }

    .card:hover { transform: translateY(-5px); }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .header-left { display: flex; flex-direction: column; gap: 0.2rem; }
    .sector { font-size: 0.95rem; font-weight: bold; margin: 0; }
    .tipo { font-size: 1.1rem; font-weight: 700; margin: 0; }
    .flag { width: 32px; height: auto; align-self: flex-start; }

    .divider {
      border: none;
      border-top: 2px solid #c00000;
      margin: 0.8rem 0 1rem;
    }

    .card-body { text-align: center; }
    .logo {
      max-width: 200px; height: auto; object-fit: contain;
      margin: 0.5rem auto 1rem; display: block;
    }
    .descripcion { font-size: 0.95rem; margin: 0.5rem 0 1rem; }
    .confidencial { color: #666; font-style: italic; }
  </style>

</BaseLayout>
